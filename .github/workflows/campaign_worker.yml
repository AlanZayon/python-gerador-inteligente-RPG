name: RPG Campaign Worker

on:
  workflow_dispatch:

jobs:
  process-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: pip install -r requirements.txt

      - name: Executar Worker
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          python - << 'EOF'
          import os
          import sys
          import redis
          import requests
          from datetime import datetime

          sys.path.append(os.getcwd())
          from tasks.campaign_tasks import process_campaign_generation

          REDIS_URL = os.environ['REDIS_URL']
          conn = redis.from_url(REDIS_URL, decode_responses=True)

          print('âœ… Conectado ao Redis')

          MAX_JOBS_PER_RUN = 5
          TEMP_DIR = '/tmp'

          for _ in range(MAX_JOBS_PER_RUN):
              job_id = conn.lpop('rpg:pending_jobs')

              if not job_id:
                  print('â„¹ï¸ Nenhum job pendente na fila.')
                  break

              print(f'ðŸ”§ Processando job: {job_id}')
              job_key = f'rpg:job:{job_id}'

              try:
                  job_data = conn.hgetall(job_key)

                  if not job_data:
                      print(f'âš ï¸ Job {job_id} nÃ£o encontrado.')
                      continue

                  conn.hset(job_key, mapping={
                      'status': 'processing',
                      'processed_at': datetime.utcnow().isoformat()
                  })

                  # =========================
                  # Download do PDF (S3)
                  # =========================
                  file_url = job_data['file_url']
                  filename = job_data['filename']

                  # =========================
                  # Processamento
                  # =========================
                  result = process_campaign_generation(
                      job_id=job_id,
                      file_url=file_url,
                      filename=filename,
                      target_language=job_data.get('language', 'pt'),
                      campaign_complexity=job_data.get('complexity', 'mediana')
                  )

                  if result:
                      conn.hset(f'{job_key}:result', mapping=result)
                      conn.hset(job_key, 'status', 'completed')
                      print(f'âœ… Job {job_id} finalizado.')
                  else:
                      conn.hset(job_key, mapping={
                          'status': 'failed',
                          'error': 'Resultado vazio'
                      })
                      print(f'âŒ Job {job_id} falhou.')

              except Exception as e:
                  print(f'ðŸš¨ Erro no job {job_id}: {e}')
                  conn.hset(job_key, mapping={
                      'status': 'failed',
                      'error': str(e)
                  })

          print('ðŸ Worker finalizado.')
          EOF
